{
  "$id": "https://atomforge.ai/schemas/crystal-1.1.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "AtomForge Crystal v1.1",
  "description": "A comprehensive schema for representing crystal structures with full provenance tracking and validation",
  "type": "object",
  "required": ["lattice", "symmetry", "sites", "composition", "provenance"],
  "properties": {
    "lattice": {
      "type": "object",
      "description": "Unit cell parameters defining the crystal lattice",
      "required": ["a", "b", "c", "alpha", "beta", "gamma"],
      "properties": {
        "a": {
          "type": "number",
          "description": "Lattice parameter a in Angstroms",
          "exclusiveMinimum": 0
        },
        "b": {
          "type": "number",
          "description": "Lattice parameter b in Angstroms",
          "exclusiveMinimum": 0
        },
        "c": {
          "type": "number",
          "description": "Lattice parameter c in Angstroms",
          "exclusiveMinimum": 0
        },
        "alpha": {
          "type": "number",
          "description": "Angle alpha in degrees",
          "minimum": 0,
          "maximum": 180
        },
        "beta": {
          "type": "number",
          "description": "Angle beta in degrees",
          "minimum": 0,
          "maximum": 180
        },
        "gamma": {
          "type": "number",
          "description": "Angle gamma in degrees",
          "minimum": 0,
          "maximum": 180
        }
      },
      "additionalProperties": false
    },
    "symmetry": {
      "type": "object",
      "description": "Crystallographic symmetry information",
      "required": ["space_group", "number"],
      "properties": {
        "space_group": {
          "type": "string",
          "description": "Hermann-Mauguin space group symbol",
          "minLength": 1,
          "pattern": "^[A-Z][0-9_/]*$"
        },
        "number": {
          "type": "integer",
          "description": "International space group number",
          "minimum": 1,
          "maximum": 230
        },
        "hall_symbol": {
          "type": "string",
          "description": "Hall symbol for the space group"
        },
        "origin_choice": {
          "type": "string",
          "description": "Origin choice specification"
        },
        "symmetry_source": {
          "type": "string",
          "enum": ["provided", "inferred"],
          "description": "Whether symmetry was provided or inferred from structure"
        }
      },
      "additionalProperties": false
    },
    "sites": {
      "type": "array",
      "description": "Atomic sites in the crystal structure (symmetry-unique only)",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["species", "frac"],
        "properties": {
          "species": {
            "type": "object",
            "description": "Chemical species and their occupancies",
            "minProperties": 1,
            "additionalProperties": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            }
          },
          "frac": {
            "type": "array",
            "description": "Fractional coordinates in [0,1)",
            "prefixItems": [
              {"type": "number"},
              {"type": "number"},
              {"type": "number"}
            ],
            "items": false,
            "minItems": 3,
            "maxItems": 3
          },
          "wyckoff": {
            "type": "string",
            "description": "Wyckoff position letter",
            "pattern": "^[a-z]$"
          },
          "multiplicity": {
            "type": "integer",
            "description": "Site multiplicity",
            "minimum": 1
          },
          "label": {
            "type": "string",
            "description": "Optional site label"
          },
          "magnetic_moment": {
            "type": "array",
            "description": "Magnetic moment vector",
            "prefixItems": [
              {"type": "number"},
              {"type": "number"},
              {"type": "number"}
            ],
            "items": false,
            "minItems": 3,
            "maxItems": 3
          },
          "charge": {
            "type": "number",
            "description": "Formal charge on the site"
          },
          "disorder_group": {
            "type": "string",
            "description": "Disorder group identifier for correlated occupancies"
          }
        },
        "additionalProperties": false
      }
    },
    "composition": {
      "type": "object",
      "description": "Chemical composition information",
      "required": ["reduced", "atomic_fractions"],
      "properties": {
        "reduced": {
          "type": "object",
          "description": "Reduced integer formula",
          "minProperties": 1,
          "additionalProperties": {
            "type": "integer",
            "minimum": 0
          }
        },
        "atomic_fractions": {
          "type": "object",
          "description": "Atomic fractions normalized to 1.0",
          "minProperties": 1,
          "additionalProperties": {
            "type": "number",
            "minimum": 0,
            "maximum": 1
          }
        }
      },
      "additionalProperties": false
    },
    "oxidation_states": {
      "type": "object",
      "description": "Oxidation states for chemical species",
      "additionalProperties": {
        "type": "number"
      }
    },
    "constraints": {
      "type": "object",
      "description": "Physical and computational constraints",
      "properties": {
        "min_interatomic_distance": {
          "type": "number",
          "description": "Minimum interatomic distance in Angstroms",
          "exclusiveMinimum": 0
        },
        "charge_neutrality": {
          "type": "boolean",
          "description": "Whether charge neutrality is enforced"
        },
        "symmetry_locked": {
          "type": "boolean",
          "description": "Whether symmetry-breaking edits are forbidden"
        }
      },
      "additionalProperties": false
    },
    "provenance": {
      "type": "object",
      "description": "Complete provenance tracking information",
      "required": ["schema_version"],
      "properties": {
        "database": {
          "type": "string",
          "description": "Source database identifier",
          "enum": ["MP", "ICSD", "COD", "user"]
        },
        "id": {
          "type": "string",
          "description": "Database-specific identifier (e.g., mp-12345)"
        },
        "doi": {
          "type": "string",
          "description": "Digital Object Identifier",
          "format": "uri"
        },
        "retrieved_at": {
          "type": "string",
          "description": "ISO 8601 timestamp of data retrieval",
          "format": "date-time"
        },
        "generator": {
          "type": "string",
          "description": "Generator identifier if produced by automated system"
        },
        "schema_version": {
          "type": "string",
          "description": "Schema version identifier",
          "const": "AtomForge/Crystal/1.1"
        },
        "hash": {
          "type": "string",
          "description": "Canonical identity hash (SHA-256)",
          "pattern": "^[a-f0-9]{64}$"
        },
        "external_ids": {
          "type": "object",
          "description": "External database identifiers",
          "additionalProperties": {
            "type": "string"
          }
        }
      },
      "additionalProperties": false
    },
    "notes": {
      "type": "string",
      "description": "Optional human-readable notes about the structure"
    }
  },
  "additionalProperties": false,
  "allOf": [
    {
      "if": {
        "properties": {
          "constraints": {
            "properties": {
              "charge_neutrality": { "const": true }
            },
            "required": ["charge_neutrality"]
          }
        }
      },
      "then": {
        "required": ["oxidation_states"],
        "properties": {
          "oxidation_states": {
            "minProperties": 1
          }
        }
      }
    }
  ]
} 